<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Engineering Exams Platform</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #1a5f7a;
            --secondary-color: #57cc99;
            --accent-color: #ff6b6b;
            --light-color: #f8f9fa;
            --dark-color: #2d3436;
            --border-radius: 8px;
            --box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f8f9fa;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
        }

        /* Header Styles */
        header {
            background: linear-gradient(to right, var(--primary-color), #2a7a9c);
            color: white;
            padding: 1.2rem 0;
            box-shadow: var(--box-shadow);
        }

        .header-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo i {
            font-size: 2.2rem;
            color: var(--secondary-color);
        }

        .logo h1 {
            font-size: 1.8rem;
            font-weight: 700;
        }

        .logo span {
            font-size: 1rem;
            opacity: 0.9;
            font-weight: 400;
        }

        /* Field Selector */
        .field-selector-container {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .field-label {
            font-weight: 600;
            font-size: 1rem;
        }

        .field-dropdown {
            position: relative;
        }

        .field-dropdown-btn {
            background: rgba(255, 255, 255, 0.15);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 0.6rem 1.2rem;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            min-width: 220px;
            justify-content: space-between;
            transition: all 0.3s ease;
        }

        .field-dropdown-btn:hover {
            background: rgba(255, 255, 255, 0.25);
        }

        .field-dropdown-content {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            z-index: 1000;
            display: none;
            margin-top: 5px;
            overflow: hidden;
        }

        .field-dropdown-content.show {
            display: block;
        }

        .field-option {
            padding: 0.8rem 1rem;
            color: var(--dark-color);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s ease;
            border-bottom: 1px solid #eee;
        }

        .field-option:last-child {
            border-bottom: none;
        }

        .field-option:hover {
            background-color: #f8f9fa;
        }

        .field-option i {
            font-size: 1.2rem;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--secondary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
        }

        /* Navigation Styles */
        .main-nav {
            background-color: white;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            margin-bottom: 2rem;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .nav-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .nav-links {
            display: flex;
            list-style: none;
        }

        .nav-links li {
            position: relative;
        }

        .nav-links a {
            display: block;
            padding: 1rem 1.5rem;
            text-decoration: none;
            color: var(--dark-color);
            font-weight: 600;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
        }

        .nav-links a:hover, .nav-links a.active {
            background-color: #f8f9fa;
            color: var(--primary-color);
        }

        .nav-links a.active {
            border-bottom-color: var(--secondary-color);
        }

        .nav-links a i {
            margin-right: 8px;
        }

        /* Main Content Styles */
        main {
            padding-bottom: 3rem;
            min-height: 70vh;
        }

        .section {
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 1.8rem;
            margin-bottom: 2rem;
            display: none;
        }

        .section.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .section-title {
            color: var(--primary-color);
            margin-bottom: 1.5rem;
            padding-bottom: 0.8rem;
            border-bottom: 2px solid #eee;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-title i {
            color: var(--secondary-color);
        }

        .field-indicator {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 0.3rem 0.8rem;
            background-color: var(--primary-color);
            color: white;
            border-radius: 20px;
            font-size: 0.9rem;
            margin-left: 10px;
        }

        /* File List Styles */
        .file-list {
            list-style: none;
            padding-left: 0;
        }

        .file-list li {
            padding: 1rem;
            border: 1px solid #eee;
            border-radius: var(--border-radius);
            margin-bottom: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
        }

        .file-list li:hover {
            border-color: var(--secondary-color);
            background-color: #f9fffc;
            transform: translateX(5px);
        }

        .file-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .file-icon {
            width: 40px;
            height: 40px;
            background-color: #e9ecef;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary-color);
            font-size: 1.2rem;
        }

        .file-details h4 {
            margin-bottom: 5px;
            color: var(--dark-color);
        }

        .file-details p {
            font-size: 0.9rem;
            color: #666;
        }

        .file-actions {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 0.6rem 1.2rem;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background-color: #144d63;
        }

        .btn-secondary {
            background-color: var(--secondary-color);
            color: white;
        }

        .btn-secondary:hover {
            background-color: #3fa67a;
        }

        /* Subject Selection */
        .subject-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 1.5rem;
            margin-top: 1.5rem;
        }

        .subject-card {
            background-color: white;
            border: 2px solid #eee;
            border-radius: var(--border-radius);
            padding: 1.5rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .subject-card:hover {
            border-color: var(--secondary-color);
            transform: translateY(-5px);
            box-shadow: var(--box-shadow);
        }

        .subject-card i {
            font-size: 2.5rem;
            color: var(--primary-color);
            margin-bottom: 1rem;
        }

        .subject-card h3 {
            color: var(--dark-color);
            font-size: 1.2rem;
        }

        .subject-card p {
            font-size: 0.9rem;
            color: #666;
            margin-top: 0.5rem;
        }

        /* MCQ Section */
        .mcq-container {
            max-width: 800px;
            margin: 0 auto;
        }

        .mcq-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding: 1rem;
            background-color: #f8f9fa;
            border-radius: var(--border-radius);
        }

        .mcq-counter {
            font-weight: bold;
            color: var(--primary-color);
        }

        .mcq-question {
            background-color: #f8f9fa;
            padding: 1.5rem;
            border-radius: var(--border-radius);
            margin-bottom: 1.5rem;
            border-left: 4px solid var(--primary-color);
        }

        .mcq-question h3 {
            margin-bottom: 1rem;
            color: var(--dark-color);
        }

        .mcq-options {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 1.5rem;
        }

        .mcq-option {
            padding: 1rem;
            border: 2px solid #ddd;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .mcq-option:hover {
            border-color: var(--secondary-color);
            background-color: #f9fffc;
        }

        .mcq-option.selected {
            border-color: var(--secondary-color);
            background-color: rgba(87, 204, 153, 0.1);
        }

        .mcq-option.correct {
            border-color: var(--secondary-color);
            background-color: rgba(87, 204, 153, 0.2);
        }

        .mcq-option.incorrect {
            border-color: var(--accent-color);
            background-color: rgba(255, 107, 107, 0.1);
        }

        .option-letter {
            width: 30px;
            height: 30px;
            background-color: #e9ecef;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: var(--dark-color);
        }

        .mcq-explanation {
            padding: 1rem;
            background-color: #e7f5ff;
            border-radius: var(--border-radius);
            margin-top: 1.5rem;
            display: none;
            border-left: 4px solid #4dabf7;
        }

        .mcq-explanation.show {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        .mcq-explanation h4 {
            color: #1971c2;
            margin-bottom: 0.5rem;
        }

        .mcq-navigation {
            display: flex;
            justify-content: space-between;
            margin-top: 2rem;
        }

        /* Loading Spinner */
        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 3rem;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Status Messages */
        .status-message {
            text-align: center;
            padding: 2rem;
            color: #666;
        }

        .error-message {
            color: #e74c3c;
            text-align: center;
            padding: 1rem;
            background-color: #fde8e8;
            border-radius: var(--border-radius);
            margin: 1rem 0;
        }

        /* Responsive Styles */
        @media (max-width: 768px) {
            .header-container {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
            
            .field-selector-container {
                width: 100%;
                justify-content: center;
            }
            
            .nav-links {
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .subject-grid {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            }
            
            .file-list li {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }
            
            .file-actions {
                align-self: flex-end;
            }
        }
    </style>
</head>
<body>
    <!-- Header Section -->
    <header>
        <div class="container header-container">
            <div class="logo">
                <i class="fas fa-university"></i>
                <div>
                    <h1>Engineering Exams Platform</h1>
                    <span>Comprehensive study resources for all engineering fields</span>
                </div>
            </div>
            
            <div class="field-selector-container">
                <span class="field-label">Select Field:</span>
                <div class="field-dropdown">
                    <button class="field-dropdown-btn">
                        <span id="current-field">
                            <i class="fas fa-building"></i> Civil Engineering
                        </span>
                        <i class="fas fa-chevron-down"></i>
                    </button>
                    <div class="field-dropdown-content">
                        <div class="field-option" data-field="civil">
                            <i class="fas fa-building"></i> Civil Engineering
                        </div>
                        <div class="field-option" data-field="mechanical">
                            <i class="fas fa-cogs"></i> Mechanical Engineering
                        </div>
                        <div class="field-option" data-field="electrical">
                            <i class="fas fa-bolt"></i> Electrical Engineering
                        </div>
                        <div class="field-option" data-field="electronics">
                            <i class="fas fa-microchip"></i> Electronics Engineering
                        </div>
                        <div class="field-option" data-field="computer">
                            <i class="fas fa-laptop-code"></i> Computer Engineering
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="user-info">
                <div class="user-avatar">JS</div>
                <div>
                    <div>John Student</div>
                    <small id="user-field">Civil Engineering</small>
                </div>
            </div>
        </div>
    </header>

    <!-- Navigation -->
    <nav class="main-nav">
        <div class="container nav-container">
            <ul class="nav-links">
                <li><a href="#" class="nav-link active" data-section="notice"><i class="fas fa-bullhorn"></i> Notice</a></li>
                <li><a href="#" class="nav-link" data-section="syllabus"><i class="fas fa-book"></i> Syllabus</a></li>
                <li><a href="#" class="nav-link" data-section="old-questions"><i class="fas fa-file-alt"></i> Old Questions</a></li>
                <li><a href="#" class="nav-link" data-section="objective-mcqs"><i class="fas fa-question-circle"></i> Objective MCQs</a></li>
                <li><a href="#" class="nav-link" data-section="subjective"><i class="fas fa-edit"></i> Subjective</a></li>
                <li><a href="#" class="nav-link" data-section="take-exam"><i class="fas fa-clock"></i> Take Exam</a></li>
            </ul>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="container">
        <!-- Notice Section -->
        <section id="notice" class="section active">
            <h2 class="section-title">
                <i class="fas fa-bullhorn"></i> Notice Board
                <span class="field-indicator" id="notice-field-indicator">
                    <i class="fas fa-building"></i> Civil
                </span>
            </h2>
            <p>All notices are displayed in chronological order (newest first).</p>
            
            <div class="loading" id="notice-loading">
                <div class="spinner"></div>
                <p>Loading notices...</p>
            </div>
            
            <ul class="file-list" id="notice-list" style="display: none;"></ul>
        </section>

        <!-- Syllabus Section -->
        <section id="syllabus" class="section">
            <h2 class="section-title">
                <i class="fas fa-book"></i> Syllabus
                <span class="field-indicator" id="syllabus-field-indicator">
                    <i class="fas fa-building"></i> Civil
                </span>
            </h2>
            <p>Access all course syllabi. You can open and download any syllabus file.</p>
            
            <div class="loading" id="syllabus-loading">
                <div class="spinner"></div>
                <p>Loading syllabus...</p>
            </div>
            
            <ul class="file-list" id="syllabus-list" style="display: none;"></ul>
        </section>

        <!-- Old Questions Section -->
        <section id="old-questions" class="section">
            <h2 class="section-title">
                <i class="fas fa-file-alt"></i> Old Questions
                <span class="field-indicator" id="old-questions-field-indicator">
                    <i class="fas fa-building"></i> Civil
                </span>
            </h2>
            <p>Previous exam questions organized in chronological order (newest first).</p>
            
            <div class="loading" id="old-questions-loading">
                <div class="spinner"></div>
                <p>Loading old questions...</p>
            </div>
            
            <ul class="file-list" id="old-questions-list" style="display: none;"></ul>
        </section>

        <!-- Objective MCQs Section -->
        <section id="objective-mcqs" class="section">
            <h2 class="section-title">
                <i class="fas fa-question-circle"></i> Objective MCQs
                <span class="field-indicator" id="mcq-field-indicator">
                    <i class="fas fa-building"></i> Civil
                </span>
            </h2>
            <p>Select a subject to practice MCQs. Answer and see explanations.</p>
            
            <div class="subject-selection">
                <h3>Choose a Subject:</h3>
                <div class="loading" id="mcq-subjects-loading">
                    <div class="spinner"></div>
                    <p>Loading subjects...</p>
                </div>
                <div class="subject-grid" id="subject-grid" style="display: none;"></div>
            </div>
            
            <!-- Chapter Selection -->
            <div id="chapter-selection" style="display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                    <h3 id="chapter-selection-title">Select Chapter</h3>
                    <button class="btn btn-secondary" id="back-to-subjects-from-chapter">
                        <i class="fas fa-arrow-left"></i> Back to Subjects
                    </button>
                </div>
                <div class="subject-grid" id="chapter-grid"></div>
            </div>
            
            <!-- MCQ Practice Area -->
            <div id="mcq-practice" style="display: none;">
                <div class="mcq-header">
                    <div>
                        <h3 id="mcq-subject-title">Subject MCQs</h3>
                        <div class="mcq-counter">Question <span id="current-question">1</span> of <span id="total-questions">10</span></div>
                    </div>
                    <div>
                        <button class="btn btn-secondary" id="back-to-chapters">
                            <i class="fas fa-arrow-left"></i> Back to Chapters
                        </button>
                    </div>
                </div>
                
                <div class="mcq-container">
                    <div class="mcq-question">
                        <h3 id="question-text">Loading question...</h3>
                    </div>
                    
                    <div class="mcq-options" id="mcq-options-container"></div>
                    
                    <div class="mcq-explanation" id="explanation">
                        <h4><i class="fas fa-lightbulb"></i> Explanation</h4>
                        <p id="explanation-text">Explanation will appear here.</p>
                    </div>
                    
                    <div class="mcq-navigation">
                        <button class="btn btn-primary" id="prev-question">
                            <i class="fas fa-chevron-left"></i> Previous
                        </button>
                        <button class="btn btn-primary" id="next-question">
                            Next <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- Subjective Section -->
        <section id="subjective" class="section">
            <h2 class="section-title">
                <i class="fas fa-edit"></i> Subjective Questions
                <span class="field-indicator" id="subjective-field-indicator">
                    <i class="fas fa-building"></i> Civil
                </span>
            </h2>
            <p>Select a subject to read subjective questions and answers.</p>
            
            <div class="subject-selection">
                <h3>Choose a Subject:</h3>
                <div class="loading" id="subjective-loading">
                    <div class="spinner"></div>
                    <p>Loading subjects...</p>
                </div>
                <div class="subject-grid" id="subjective-subject-grid" style="display: none;"></div>
            </div>
            
            <!-- Subjective Content Area -->
            <div id="subjective-content" style="display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                    <h3 id="subjective-set-title">Subjective Questions</h3>
                    <button class="btn btn-secondary" id="back-to-subjective-subjects">
                        <i class="fas fa-arrow-left"></i> Back to Subjects
                    </button>
                </div>
                
                <div class="subject-grid" id="subjective-file-grid"></div>
            </div>
        </section>

        <!-- Take Exam Section -->
        <section id="take-exam" class="section">
            <h2 class="section-title">
                <i class="fas fa-clock"></i> Take Exam
                <span class="field-indicator" id="exam-field-indicator">
                    <i class="fas fa-building"></i> Civil
                </span>
            </h2>
            <p>Choose between Subjective or Multiple Choice exam formats.</p>
            
            <div class="exam-type-selection" id="exam-type-selection">
                <h3>Select Exam Type:</h3>
                <div style="display: flex; gap: 2rem; margin-top: 1.5rem;">
                    <div class="subject-card" style="flex: 1;" data-exam-type="subjective">
                        <i class="fas fa-edit"></i>
                        <h3>Subjective Exam</h3>
                        <p>3-hour timer, all questions displayed at once</p>
                    </div>
                    <div class="subject-card" style="flex: 1;" data-exam-type="multiple-choice">
                        <i class="fas fa-check-circle"></i>
                        <h3>Multiple Choice Exam</h3>
                        <p>30-minute timer, view answers after submission</p>
                    </div>
                </div>
            </div>
            
            <!-- Exam Set Selection -->
            <div id="exam-set-selection" style="display: none;"></div>
            
            <!-- Multiple Choice Exam -->
            <div id="multiple-choice-exam" style="display: none;">
                <div class="mcq-container">
                    <div class="mcq-header">
                        <div>
                            <h3 id="multiple-choice-exam-title">Multiple Choice Exam</h3>
                            <div class="timer" id="mcq-exam-timer">30:00</div>
                        </div>
                        <div class="mcq-counter">Question <span id="current-exam-question">1</span> of <span id="total-exam-questions">10</span></div>
                    </div>
                    
                    <div class="mcq-question">
                        <h3 id="mcq-exam-question-text">Question will appear here</h3>
                    </div>
                    
                    <div class="mcq-options" id="mcq-exam-options-container"></div>
                    
                    <div class="mcq-navigation" style="justify-content: space-between; margin-top: 2rem;">
                        <button class="btn btn-primary" id="prev-exam-question">
                            <i class="fas fa-chevron-left"></i> Previous
                        </button>
                        <button class="btn btn-primary" id="next-exam-question">
                            Next <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                    
                    <div style="margin-top: 2rem; text-align: center;">
                        <button class="btn btn-primary" id="submit-mcq-exam" style="padding: 0.8rem 2rem;">
                            <i class="fas fa-paper-plane"></i> Submit Exam
                        </button>
                        <button class="btn btn-secondary" id="back-to-exam-type-mcq">
                            <i class="fas fa-arrow-left"></i> Back to Exam Type
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Exam Results -->
            <div id="exam-results" style="display: none;">
                <div style="background-color: #e7f5ff; padding: 2rem; border-radius: var(--border-radius); text-align: center; margin-top: 2rem;">
                    <h3><i class="fas fa-trophy"></i> Exam Submitted Successfully!</h3>
                    <div style="font-size: 3rem; color: var(--secondary-color); font-weight: bold; margin: 1.5rem 0;" id="exam-score">85%</div>
                    <p>Your score: <strong id="exam-correct-answers">17</strong> out of <strong id="exam-total-questions">20</strong> questions correct</p>
                    
                    <button class="btn btn-secondary" id="back-to-exam-type-results" style="margin-top: 2rem;">
                        <i class="fas fa-redo"></i> Take Another Exam
                    </button>
                </div>
            </div>
        </section>
    </main>

    <script>
        // ==============================================
        // BACKBLAZE B2 CONFIGURATION
        // ==============================================
        const B2_CONFIG = {
            bucketId: '349b4754528fa2c69db90511',
            accountId: '4b742f26d951',
            applicationKey: '005a773e68d6d93041dade4c85ba43a86a11278348',
            bucketName: 'Bridge4ER'
        };

        // Field configuration
        const FIELD_CONFIG = {
            civil: {
                name: "Civil Engineering",
                icon: "fa-building",
                color: "#1a5f7a",
                folderPrefix: "Civil Engineering/"
            },
            mechanical: {
                name: "Mechanical Engineering",
                icon: "fa-cogs",
                color: "#e74c3c",
                folderPrefix: "Mechanical Engineering/"
            },
            electrical: {
                name: "Electrical Engineering",
                icon: "fa-bolt",
                color: "#f39c12",
                folderPrefix: "Electrical Engineering/"
            },
            electronics: {
                name: "Electronics Engineering",
                icon: "fa-microchip",
                color: "#9b59b6",
                folderPrefix: "Electronics Engineering/"
            },
            computer: {
                name: "Computer Engineering",
                icon: "fa-laptop-code",
                color: "#3498db",
                folderPrefix: "Computer Engineering/"
            }
        };

        // ==============================================
        // APPLICATION STATE
        // ==============================================
        const AppState = {
            currentField: 'civil',
            currentSection: 'notice',
            mcqState: {
                currentSubject: null,
                currentChapter: null,
                currentQuestionIndex: 0,
                questions: [],
                userAnswers: {}
            },
            examState: {
                type: null,
                currentSet: null,
                currentQuestionIndex: 0,
                questions: [],
                answers: {},
                timer: null,
                timeLeft: 1800 // 30 minutes in seconds
            },
            b2Auth: null
        };

        // ==============================================
        // CORE B2 API FUNCTIONS
        // ==============================================
        async function getB2Auth() {
            if (AppState.b2Auth) return AppState.b2Auth;
            
            try {
                const authString = `${B2_CONFIG.accountId}:${B2_CONFIG.applicationKey}`;
                const encodedAuth = btoa(authString);
                
                const response = await fetch('https://api.backblazeb2.com/b2api/v2/b2_authorize_account', {
                    headers: { 'Authorization': `Basic ${encodedAuth}` }
                });
                
                if (!response.ok) throw new Error('Auth failed');
                
                const data = await response.json();
                AppState.b2Auth = {
                    token: data.authorizationToken,
                    apiUrl: data.apiUrl,
                    downloadUrl: data.downloadUrl
                };
                return AppState.b2Auth;
            } catch (error) {
                console.error('B2 Auth Error:', error);
                return null;
            }
        }

        async function listFiles(prefix = '', delimiter = '/') {
            try {
                const auth = await getB2Auth();
                if (!auth) return [];
                
                const response = await fetch(`${auth.apiUrl}/b2api/v2/b2_list_file_names`, {
                    method: 'POST',
                    headers: {
                        'Authorization': auth.token,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        bucketId: B2_CONFIG.bucketId,
                        prefix: prefix,
                        delimiter: delimiter,
                        maxFileCount: 1000
                    })
                });
                
                if (!response.ok) throw new Error('List files failed');
                
                const data = await response.json();
                return data.files || [];
            } catch (error) {
                console.error('List Files Error:', error);
                return [];
            }
        }

        function getFileUrl(fileName) {
            return `https://f005.backblazeb2.com/file/${B2_CONFIG.bucketName}/${fileName}`;
        }

        // ==============================================
        // UTILITY FUNCTIONS
        // ==============================================
        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' Bytes';
            if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / 1048576).toFixed(1) + ' MB';
        }

        function getFileIcon(ext) {
            const icons = {
                'pdf': 'fa-file-pdf',
                'doc': 'fa-file-word',
                'docx': 'fa-file-word',
                'xls': 'fa-file-excel',
                'xlsx': 'fa-file-excel',
                'ppt': 'fa-file-powerpoint',
                'pptx': 'fa-file-powerpoint',
                'jpg': 'fa-file-image',
                'jpeg': 'fa-file-image',
                'png': 'fa-file-image',
                'gif': 'fa-file-image',
                'json': 'fa-file-code'
            };
            return icons[ext.toLowerCase()] || 'fa-file-alt';
        }

        function hideLoading(id) {
            const el = document.getElementById(id);
            if (el) el.style.display = 'none';
        }

        function showContent(id) {
            const el = document.getElementById(id);
            if (el) el.style.display = 'block';
        }

        // ==============================================
        // FILE LOADING FUNCTIONS
        // ==============================================
        async function loadNoticeFiles() {
            const prefix = `${FIELD_CONFIG[AppState.currentField].folderPrefix}Notice/`;
            try {
                const files = await listFiles(prefix);
                const noticeList = document.getElementById('notice-list');
                
                if (files.length === 0) {
                    noticeList.innerHTML = '<li class="status-message"><p>No notice files available.</p></li>';
                } else {
                    noticeList.innerHTML = files.filter(f => !f.fileName.endsWith('/')).map(file => {
                        const name = file.fileName.split('/').pop();
                        const ext = name.split('.').pop();
                        const date = new Date(file.uploadTimestamp).toLocaleDateString();
                        return `
                            <li>
                                <div class="file-info">
                                    <div class="file-icon"><i class="fas ${getFileIcon(ext)}"></i></div>
                                    <div class="file-details">
                                        <h4>${name.replace(/\.[^/.]+$/, '').replace(/[_-]/g, ' ')}</h4>
                                        <p>Uploaded: ${date} | Size: ${formatFileSize(file.size)}</p>
                                    </div>
                                </div>
                                <div class="file-actions">
                                    <button class="btn btn-primary" onclick="viewFile('${file.fileName}')">
                                        <i class="fas fa-eye"></i> View
                                    </button>
                                    <button class="btn btn-secondary" onclick="downloadFile('${file.fileName}')">
                                        <i class="fas fa-download"></i> Download
                                    </button>
                                </div>
                            </li>
                        `;
                    }).join('');
                }
                
                hideLoading('notice-loading');
                showContent('notice-list');
            } catch (error) {
                document.getElementById('notice-list').innerHTML = '<li class="error-message"><p>Error loading notices.</p></li>';
                hideLoading('notice-loading');
                showContent('notice-list');
            }
        }

        async function loadSyllabusFiles() {
            const prefix = `${FIELD_CONFIG[AppState.currentField].folderPrefix}Syllabus/`;
            try {
                const files = await listFiles(prefix);
                const syllabusList = document.getElementById('syllabus-list');
                
                if (files.length === 0) {
                    syllabusList.innerHTML = '<li class="status-message"><p>No syllabus files available.</p></li>';
                } else {
                    syllabusList.innerHTML = files.filter(f => !f.fileName.endsWith('/')).map(file => {
                        const name = file.fileName.split('/').pop();
                        const ext = name.split('.').pop();
                        const date = new Date(file.uploadTimestamp).toLocaleDateString();
                        return `
                            <li>
                                <div class="file-info">
                                    <div class="file-icon"><i class="fas ${getFileIcon(ext)}"></i></div>
                                    <div class="file-details">
                                        <h4>${name.replace(/\.[^/.]+$/, '').replace(/[_-]/g, ' ')}</h4>
                                        <p>Uploaded: ${date} | Size: ${formatFileSize(file.size)}</p>
                                    </div>
                                </div>
                                <div class="file-actions">
                                    <button class="btn btn-primary" onclick="viewFile('${file.fileName}')">
                                        <i class="fas fa-eye"></i> View
                                    </button>
                                    <button class="btn btn-secondary" onclick="downloadFile('${file.fileName}')">
                                        <i class="fas fa-download"></i> Download
                                    </button>
                                </div>
                            </li>
                        `;
                    }).join('');
                }
                
                hideLoading('syllabus-loading');
                showContent('syllabus-list');
            } catch (error) {
                document.getElementById('syllabus-list').innerHTML = '<li class="error-message"><p>Error loading syllabus.</p></li>';
                hideLoading('syllabus-loading');
                showContent('syllabus-list');
            }
        }

        async function loadOldQuestionFiles() {
            const prefix = `${FIELD_CONFIG[AppState.currentField].folderPrefix}Old Questions/`;
            try {
                const files = await listFiles(prefix);
                const oldQuestionsList = document.getElementById('old-questions-list');
                
                if (files.length === 0) {
                    oldQuestionsList.innerHTML = '<li class="status-message"><p>No old question files available.</p></li>';
                } else {
                    oldQuestionsList.innerHTML = files.filter(f => !f.fileName.endsWith('/')).map(file => {
                        const name = file.fileName.split('/').pop();
                        const ext = name.split('.').pop();
                        const date = new Date(file.uploadTimestamp).toLocaleDateString();
                        return `
                            <li>
                                <div class="file-info">
                                    <div class="file-icon"><i class="fas ${getFileIcon(ext)}"></i></div>
                                    <div class="file-details">
                                        <h4>${name.replace(/\.[^/.]+$/, '').replace(/[_-]/g, ' ')}</h4>
                                        <p>Uploaded: ${date} | Size: ${formatFileSize(file.size)}</p>
                                    </div>
                                </div>
                                <div class="file-actions">
                                    <button class="btn btn-primary" onclick="viewFile('${file.fileName}')">
                                        <i class="fas fa-eye"></i> View
                                    </button>
                                    <button class="btn btn-secondary" onclick="downloadFile('${file.fileName}')">
                                        <i class="fas fa-download"></i> Download
                                    </button>
                                </div>
                            </li>
                        `;
                    }).join('');
                }
                
                hideLoading('old-questions-loading');
                showContent('old-questions-list');
            } catch (error) {
                document.getElementById('old-questions-list').innerHTML = '<li class="error-message"><p>Error loading old questions.</p></li>';
                hideLoading('old-questions-loading');
                showContent('old-questions-list');
            }
        }

        // ==============================================
        // OBJECTIVE MCQ FUNCTIONS
        // ==============================================
        async function loadMCQSubjects() {
            const prefix = `${FIELD_CONFIG[AppState.currentField].folderPrefix}Objective MCQs/`;
            try {
                const files = await listFiles(prefix, '/');
                const subjects = new Set();
                
                files.forEach(file => {
                    const parts = file.fileName.split('/');
                    if (parts.length >= 3 && parts[2] && !parts[2].includes('.')) {
                        subjects.add(parts[2]);
                    }
                });
                
                const subjectGrid = document.getElementById('subject-grid');
                if (subjects.size === 0) {
                    subjectGrid.innerHTML = '<div class="status-message" style="grid-column: 1/-1"><p>No MCQ subjects available.</p></div>';
                } else {
                    const subjectIcons = {
                        'GK': 'fa-globe',
                        'Geotech': 'fa-mountain',
                        'Hydropower': 'fa-water',
                        'IQ': 'fa-brain',
                        'Math': 'fa-calculator',
                        'Structure': 'fa-building'
                    };
                    
                    subjectGrid.innerHTML = Array.from(subjects).sort().map(subject => `
                        <div class="subject-card" data-subject="${subject}">
                            <i class="fas ${subjectIcons[subject] || 'fa-book'}"></i>
                            <h3>${subject}</h3>
                            <p>Practice MCQs for ${subject}</p>
                        </div>
                    `).join('');
                }
                
                hideLoading('mcq-subjects-loading');
                showContent('subject-grid');
            } catch (error) {
                document.getElementById('subject-grid').innerHTML = '<div class="error-message" style="grid-column: 1/-1"><p>Error loading subjects.</p></div>';
                hideLoading('mcq-subjects-loading');
                showContent('subject-grid');
            }
        }

        async function loadMCQChapters(subject) {
            const prefix = `${FIELD_CONFIG[AppState.currentField].folderPrefix}Objective MCQs/${subject}/`;
            try {
                const files = await listFiles(prefix);
                const chapters = new Set();
                
                files.forEach(file => {
                    const name = file.fileName.split('/').pop();
                    if (name.endsWith('.json')) {
                        chapters.add(name.replace('.json', '').replace(/_/g, ' '));
                    }
                });
                
                const chapterGrid = document.getElementById('chapter-grid');
                if (chapters.size === 0) {
                    chapterGrid.innerHTML = '<div class="status-message" style="grid-column: 1/-1"><p>No chapters available.</p></div>';
                } else {
                    chapterGrid.innerHTML = Array.from(chapters).sort().map(chapter => `
                        <div class="subject-card" data-chapter="${chapter}" data-subject="${subject}">
                            <i class="fas fa-file-alt"></i>
                            <h3>${chapter}</h3>
                            <p>MCQ questions for ${chapter}</p>
                        </div>
                    `).join('');
                }
            } catch (error) {
                document.getElementById('chapter-grid').innerHTML = '<div class="error-message" style="grid-column: 1/-1"><p>Error loading chapters.</p></div>';
            }
        }

        async function loadMCQQuestions(subject, chapter) {
            const fileName = `${FIELD_CONFIG[AppState.currentField].folderPrefix}Objective MCQs/${subject}/${chapter.replace(/ /g, '_')}.json`;
            
            try {
                const fileUrl = getFileUrl(fileName);
                const response = await fetch(fileUrl);
                
                if (!response.ok) throw new Error('Failed to load questions');
                
                const data = await response.json();
                let questions = [];
                
                if (Array.isArray(data)) {
                    questions = data;
                } else if (data.questions && Array.isArray(data.questions)) {
                    questions = data.questions;
                }
                
                // Format questions
                return questions.map((q, i) => ({
                    id: `${subject}_${chapter}_${i}`,
                    question: q.question || `Question ${i+1}`,
                    options: q.options || ["Option A", "Option B", "Option C", "Option D"],
                    correct: q.correct || (q.options ? q.options[0] : "Option A"),
                    explanation: q.explanation || "No explanation available"
                }));
            } catch (error) {
                console.error('Error loading MCQ questions:', error);
                // Return sample questions if file not found
                return Array.from({length: 5}, (_, i) => ({
                    id: `sample_${i}`,
                    question: `Sample question ${i+1} for ${subject} - ${chapter}`,
                    options: ["Option A", "Option B", "Option C", "Option D"],
                    correct: ["Option A", "Option B", "Option C", "Option D"][i % 4],
                    explanation: "This is a sample explanation."
                }));
            }
        }

        function loadMCQQuestion() {
            const state = AppState.mcqState;
            const question = state.questions[state.currentQuestionIndex];
            
            document.getElementById('current-question').textContent = state.currentQuestionIndex + 1;
            document.getElementById('total-questions').textContent = state.questions.length;
            document.getElementById('question-text').textContent = question.question;
            
            const optionsContainer = document.getElementById('mcq-options-container');
            optionsContainer.innerHTML = '';
            
            ['A', 'B', 'C', 'D'].forEach((letter, index) => {
                if (question.options[index]) {
                    const optionDiv = document.createElement('div');
                    optionDiv.className = 'mcq-option';
                    optionDiv.dataset.index = index;
                    optionDiv.innerHTML = `
                        <div class="option-letter">${letter}</div>
                        <div>${question.options[index]}</div>
                    `;
                    optionsContainer.appendChild(optionDiv);
                }
            });
            
            document.getElementById('explanation').classList.remove('show');
            document.getElementById('prev-question').disabled = state.currentQuestionIndex === 0;
            document.getElementById('next-question').disabled = state.currentQuestionIndex === state.questions.length - 1;
        }

        // ==============================================
        // SUBJECTIVE FUNCTIONS
        // ==============================================
        async function loadSubjectiveSubjects() {
            const prefix = `${FIELD_CONFIG[AppState.currentField].folderPrefix}Subjective/`;
            try {
                const files = await listFiles(prefix, '/');
                const subjects = new Set();
                
                files.forEach(file => {
                    const parts = file.fileName.split('/');
                    if (parts.length >= 3 && parts[2] && !parts[2].includes('.')) {
                        subjects.add(parts[2]);
                    }
                });
                
                const subjectGrid = document.getElementById('subjective-subject-grid');
                if (subjects.size === 0) {
                    subjectGrid.innerHTML = '<div class="status-message" style="grid-column: 1/-1"><p>No subjective subjects available.</p></div>';
                } else {
                    const subjectIcons = {
                        'Geotechnical': 'fa-mountain',
                        'Highway': 'fa-road',
                        'Hydropower': 'fa-water',
                        'Structure': 'fa-building'
                    };
                    
                    subjectGrid.innerHTML = Array.from(subjects).sort().map(subject => `
                        <div class="subject-card" data-subject="${subject}">
                            <i class="fas ${subjectIcons[subject] || 'fa-book'}"></i>
                            <h3>${subject}</h3>
                            <p>Read subjective questions for ${subject}</p>
                        </div>
                    `).join('');
                }
                
                hideLoading('subjective-loading');
                showContent('subjective-subject-grid');
            } catch (error) {
                document.getElementById('subjective-subject-grid').innerHTML = '<div class="error-message" style="grid-column: 1/-1"><p>Error loading subjects.</p></div>';
                hideLoading('subjective-loading');
                showContent('subjective-subject-grid');
            }
        }

        async function loadSubjectiveFiles(subject) {
            const prefix = `${FIELD_CONFIG[AppState.currentField].folderPrefix}Subjective/${subject}/`;
            try {
                const files = await listFiles(prefix);
                const fileGrid = document.getElementById('subjective-file-grid');
                
                if (files.length === 0) {
                    fileGrid.innerHTML = '<div class="status-message" style="grid-column: 1/-1"><p>No files available for this subject.</p></div>';
                } else {
                    fileGrid.innerHTML = files.filter(f => !f.fileName.endsWith('/')).map(file => {
                        const name = file.fileName.split('/').pop();
                        const ext = name.split('.').pop();
                        const size = formatFileSize(file.size);
                        return `
                            <div class="subject-card" data-file="${file.fileName}">
                                <i class="fas ${getFileIcon(ext)}"></i>
                                <h3>${name.replace(/\.[^/.]+$/, '').replace(/[_-]/g, ' ')}</h3>
                                <p>Size: ${size}</p>
                            </div>
                        `;
                    }).join('');
                }
            } catch (error) {
                document.getElementById('subjective-file-grid').innerHTML = '<div class="error-message" style="grid-column: 1/-1"><p>Error loading files.</p></div>';
            }
        }

        // ==============================================
        // EXAM FUNCTIONS
        // ==============================================
        async function loadMCQExamSets() {
            const prefix = `${FIELD_CONFIG[AppState.currentField].folderPrefix}Take Exam/Multiple Choice Exam/`;
            try {
                const files = await listFiles(prefix);
                const examSets = files.filter(f => f.fileName.endsWith('.json')).map(file => {
                    const name = file.fileName.split('/').pop().replace('.json', '');
                    return { name, fileName: file.fileName };
                });
                
                return examSets;
            } catch (error) {
                console.error('Error loading exam sets:', error);
                return [];
            }
        }

        async function loadMCQExam(fileName) {
            try {
                const fileUrl = getFileUrl(fileName);
                const response = await fetch(fileUrl);
                
                if (!response.ok) throw new Error('Failed to load exam');
                
                const data = await response.json();
                let questions = [];
                
                if (Array.isArray(data)) {
                    questions = data;
                } else if (data.questions && Array.isArray(data.questions)) {
                    questions = data.questions;
                }
                
                return questions.map((q, i) => ({
                    id: `exam_${i}`,
                    question: q.question || `Question ${i+1}`,
                    options: q.options || ["Option A", "Option B", "Option C", "Option D"],
                    correct: q.correct || (q.options ? q.options[0] : "Option A"),
                    explanation: q.explanation || "No explanation available"
                }));
            } catch (error) {
                console.error('Error loading exam:', error);
                return Array.from({length: 10}, (_, i) => ({
                    id: `sample_${i}`,
                    question: `Sample exam question ${i+1}`,
                    options: ["Option A", "Option B", "Option C", "Option D"],
                    correct: ["Option A", "Option B", "Option C", "Option D"][i % 4],
                    explanation: "Sample explanation"
                }));
            }
        }

        function loadExamQuestion() {
            const state = AppState.examState;
            const question = state.questions[state.currentQuestionIndex];
            
            document.getElementById('current-exam-question').textContent = state.currentQuestionIndex + 1;
            document.getElementById('total-exam-questions').textContent = state.questions.length;
            document.getElementById('mcq-exam-question-text').textContent = question.question;
            
            const optionsContainer = document.getElementById('mcq-exam-options-container');
            optionsContainer.innerHTML = '';
            
            ['A', 'B', 'C', 'D'].forEach((letter, index) => {
                if (question.options[index]) {
                    const optionDiv = document.createElement('div');
                    optionDiv.className = 'mcq-option';
                    optionDiv.dataset.index = index;
                    optionDiv.innerHTML = `
                        <div class="option-letter">${letter}</div>
                        <div>${question.options[index]}</div>
                    `;
                    optionsContainer.appendChild(optionDiv);
                }
            });
            
            document.getElementById('prev-exam-question').disabled = state.currentQuestionIndex === 0;
            document.getElementById('next-exam-question').disabled = state.currentQuestionIndex === state.questions.length - 1;
        }

        function startExamTimer() {
            const timerElement = document.getElementById('mcq-exam-timer');
            let timeLeft = AppState.examState.timeLeft;
            
            const timer = setInterval(() => {
                const minutes = Math.floor(timeLeft / 60);
                const seconds = timeLeft % 60;
                timerElement.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                
                if (timeLeft <= 0) {
                    clearInterval(timer);
                    submitMCQExam();
                }
                timeLeft--;
            }, 1000);
            
            AppState.examState.timer = timer;
        }

        function submitMCQExam() {
            if (AppState.examState.timer) {
                clearInterval(AppState.examState.timer);
            }
            
            const state = AppState.examState;
            let correct = 0;
            
            state.questions.forEach((question, index) => {
                if (state.answers[index] === question.correct) {
                    correct++;
                }
            });
            
            const score = Math.round((correct / state.questions.length) * 100);
            
            document.getElementById('exam-score').textContent = `${score}%`;
            document.getElementById('exam-correct-answers').textContent = correct;
            document.getElementById('exam-total-questions').textContent = state.questions.length;
            
            document.getElementById('multiple-choice-exam').style.display = 'none';
            document.getElementById('exam-results').style.display = 'block';
        }

        // ==============================================
        // EVENT HANDLERS AND INITIALIZATION
        // ==============================================
        function setupEventListeners() {
            // Field dropdown
            document.querySelector('.field-dropdown-btn').addEventListener('click', () => {
                document.querySelector('.field-dropdown-content').classList.toggle('show');
            });
            
            // Field selection
            document.querySelectorAll('.field-option').forEach(option => {
                option.addEventListener('click', () => {
                    const field = option.dataset.field;
                    AppState.currentField = field;
                    const config = FIELD_CONFIG[field];
                    
                    document.getElementById('current-field').innerHTML = `<i class="fas ${config.icon}"></i> ${config.name}`;
                    document.getElementById('user-field').textContent = config.name;
                    document.documentElement.style.setProperty('--primary-color', config.color);
                    document.querySelector('header').style.background = `linear-gradient(to right, ${config.color}, ${config.color}99)`;
                    
                    document.querySelector('.field-dropdown-content').classList.remove('show');
                    
                    // Reload current section
                    loadCurrentSection();
                });
            });
            
            // Navigation
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const section = link.dataset.section;
                    
                    document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                    link.classList.add('active');
                    
                    document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
                    document.getElementById(section).classList.add('active');
                    
                    AppState.currentSection = section;
                    loadCurrentSection();
                });
            });
            
            // MCQ Subject selection
            document.addEventListener('click', (e) => {
                const subjectCard = e.target.closest('.subject-card[data-subject]');
                if (subjectCard && subjectCard.parentElement.id === 'subject-grid') {
                    const subject = subjectCard.dataset.subject;
                    document.getElementById('subject-grid').style.display = 'none';
                    document.getElementById('chapter-selection').style.display = 'block';
                    document.getElementById('chapter-selection-title').textContent = `Select Chapter - ${subject}`;
                    loadMCQChapters(subject);
                }
            });
            
            // MCQ Chapter selection
            document.addEventListener('click', (e) => {
                const chapterCard = e.target.closest('.subject-card[data-chapter]');
                if (chapterCard && chapterCard.parentElement.id === 'chapter-grid') {
                    const subject = chapterCard.dataset.subject;
                    const chapter = chapterCard.dataset.chapter;
                    
                    AppState.mcqState.currentSubject = subject;
                    AppState.mcqState.currentChapter = chapter;
                    AppState.mcqState.currentQuestionIndex = 0;
                    
                    loadMCQQuestions(subject, chapter).then(questions => {
                        AppState.mcqState.questions = questions;
                        document.getElementById('chapter-selection').style.display = 'none';
                        document.getElementById('mcq-practice').style.display = 'block';
                        document.getElementById('mcq-subject-title').textContent = `${subject} - ${chapter}`;
                        loadMCQQuestion();
                    });
                }
            });
            
            // MCQ Option selection
            document.addEventListener('click', (e) => {
                const option = e.target.closest('.mcq-option');
                if (option && option.parentElement.id === 'mcq-options-container') {
                    const index = parseInt(option.dataset.index);
                    const question = AppState.mcqState.questions[AppState.mcqState.currentQuestionIndex];
                    const selectedOption = question.options[index];
                    
                    document.querySelectorAll('#mcq-options-container .mcq-option').forEach(opt => {
                        opt.classList.remove('selected', 'correct', 'incorrect');
                    });
                    
                    option.classList.add('selected');
                    
                    if (selectedOption === question.correct) {
                        option.classList.add('correct');
                    } else {
                        option.classList.add('incorrect');
                        // Highlight correct answer
                        document.querySelectorAll('#mcq-options-container .mcq-option').forEach(opt => {
                            if (question.options[parseInt(opt.dataset.index)] === question.correct) {
                                opt.classList.add('correct');
                            }
                        });
                    }
                    
                    document.getElementById('explanation-text').textContent = question.explanation;
                    document.getElementById('explanation').classList.add('show');
                }
            });
            
            // Exam Option selection
            document.addEventListener('click', (e) => {
                const option = e.target.closest('.mcq-option');
                if (option && option.parentElement.id === 'mcq-exam-options-container') {
                    const index = parseInt(option.dataset.index);
                    const question = AppState.examState.questions[AppState.examState.currentQuestionIndex];
                    const selectedOption = question.options[index];
                    
                    document.querySelectorAll('#mcq-exam-options-container .mcq-option').forEach(opt => {
                        opt.classList.remove('selected');
                    });
                    
                    option.classList.add('selected');
                    AppState.examState.answers[AppState.examState.currentQuestionIndex] = selectedOption;
                }
            });
            
            // Navigation buttons
            document.getElementById('prev-question').addEventListener('click', () => {
                if (AppState.mcqState.currentQuestionIndex > 0) {
                    AppState.mcqState.currentQuestionIndex--;
                    loadMCQQuestion();
                }
            });
            
            document.getElementById('next-question').addEventListener('click', () => {
                if (AppState.mcqState.currentQuestionIndex < AppState.mcqState.questions.length - 1) {
                    AppState.mcqState.currentQuestionIndex++;
                    loadMCQQuestion();
                }
            });
            
            document.getElementById('prev-exam-question').addEventListener('click', () => {
                if (AppState.examState.currentQuestionIndex > 0) {
                    AppState.examState.currentQuestionIndex--;
                    loadExamQuestion();
                }
            });
            
            document.getElementById('next-exam-question').addEventListener('click', () => {
                if (AppState.examState.currentQuestionIndex < AppState.examState.questions.length - 1) {
                    AppState.examState.currentQuestionIndex++;
                    loadExamQuestion();
                }
            });
            
            // Back buttons
            document.getElementById('back-to-subjects-from-chapter').addEventListener('click', () => {
                document.getElementById('chapter-selection').style.display = 'none';
                document.getElementById('subject-grid').style.display = 'block';
            });
            
            document.getElementById('back-to-chapters').addEventListener('click', () => {
                document.getElementById('mcq-practice').style.display = 'none';
                document.getElementById('chapter-selection').style.display = 'block';
            });
            
            document.getElementById('back-to-subjective-subjects').addEventListener('click', () => {
                document.getElementById('subjective-content').style.display = 'none';
                document.getElementById('subjective-subject-grid').style.display = 'block';
            });
            
            // Subjective subject selection
            document.addEventListener('click', (e) => {
                const subjectCard = e.target.closest('.subject-card[data-subject]');
                if (subjectCard && subjectCard.parentElement.id === 'subjective-subject-grid') {
                    const subject = subjectCard.dataset.subject;
                    document.getElementById('subjective-subject-grid').style.display = 'none';
                    document.getElementById('subjective-content').style.display = 'block';
                    document.getElementById('subjective-set-title').textContent = `${subject} - Files`;
                    loadSubjectiveFiles(subject);
                }
            });
            
            // Subjective file click
            document.addEventListener('click', (e) => {
                const fileCard = e.target.closest('.subject-card[data-file]');
                if (fileCard) {
                    const fileName = fileCard.dataset.file;
                    viewFile(fileName);
                }
            });
            
            // Exam type selection
            document.addEventListener('click', (e) => {
                const examCard = e.target.closest('.subject-card[data-exam-type]');
                if (examCard && examCard.parentElement.parentElement.id === 'exam-type-selection') {
                    const type = examCard.dataset.examType;
                    
                    if (type === 'multiple-choice') {
                        loadMCQExamSets().then(sets => {
                            if (sets.length === 0) {
                                alert('No MCQ exam sets available.');
                                return;
                            }
                            
                            document.getElementById('exam-type-selection').style.display = 'none';
                            document.getElementById('exam-set-selection').style.display = 'block';
                            document.getElementById('exam-set-selection').innerHTML = `
                                <h3>Select Exam Set:</h3>
                                <div class="subject-grid" style="margin-top: 1.5rem;">
                                    ${sets.map(set => `
                                        <div class="subject-card" data-exam-file="${set.fileName}">
                                            <i class="fas fa-file-alt"></i>
                                            <h3>${set.name}</h3>
                                            <p>Multiple Choice Exam</p>
                                        </div>
                                    `).join('')}
                                </div>
                                <button class="btn btn-secondary" id="back-to-exam-type-from-set" style="margin-top: 1.5rem;">
                                    <i class="fas fa-arrow-left"></i> Back to Exam Type
                                </button>
                            `;
                            
                            document.getElementById('back-to-exam-type-from-set').addEventListener('click', () => {
                                document.getElementById('exam-set-selection').style.display = 'none';
                                document.getElementById('exam-type-selection').style.display = 'block';
                            });
                            
                            // Exam set selection
                            setTimeout(() => {
                                document.querySelectorAll('.subject-card[data-exam-file]').forEach(card => {
                                    card.addEventListener('click', async () => {
                                        const fileName = card.dataset.examFile;
                                        const questions = await loadMCQExam(fileName);
                                        
                                        AppState.examState.type = 'multiple-choice';
                                        AppState.examState.currentSet = fileName;
                                        AppState.examState.currentQuestionIndex = 0;
                                        AppState.examState.questions = questions;
                                        AppState.examState.answers = {};
                                        AppState.examState.timeLeft = 1800;
                                        
                                        document.getElementById('exam-set-selection').style.display = 'none';
                                        document.getElementById('multiple-choice-exam').style.display = 'block';
                                        document.getElementById('multiple-choice-exam-title').textContent = card.querySelector('h3').textContent;
                                        
                                        loadExamQuestion();
                                        startExamTimer();
                                    });
                                });
                            }, 100);
                        });
                    }
                }
            });
            
            // Exam back buttons
            document.getElementById('back-to-exam-type-mcq').addEventListener('click', () => {
                if (AppState.examState.timer) {
                    clearInterval(AppState.examState.timer);
                }
                document.getElementById('multiple-choice-exam').style.display = 'none';
                document.getElementById('exam-type-selection').style.display = 'block';
            });
            
            document.getElementById('back-to-exam-type-results').addEventListener('click', () => {
                document.getElementById('exam-results').style.display = 'none';
                document.getElementById('exam-type-selection').style.display = 'block';
            });
            
            // Exam submission
            document.getElementById('submit-mcq-exam').addEventListener('click', () => {
                if (confirm('Are you sure you want to submit your exam?')) {
                    submitMCQExam();
                }
            });
        }

        function loadCurrentSection() {
            switch (AppState.currentSection) {
                case 'notice':
                    loadNoticeFiles();
                    break;
                case 'syllabus':
                    loadSyllabusFiles();
                    break;
                case 'old-questions':
                    loadOldQuestionFiles();
                    break;
                case 'objective-mcqs':
                    loadMCQSubjects();
                    break;
                case 'subjective':
                    loadSubjectiveSubjects();
                    break;
            }
        }

        // ==============================================
        // GLOBAL FUNCTIONS
        // ==============================================
        window.viewFile = function(fileName) {
            const fileUrl = getFileUrl(fileName);
            window.open(fileUrl, '_blank');
        };

        window.downloadFile = function(fileName) {
            const fileUrl = getFileUrl(fileName);
            const link = document.createElement('a');
            link.href = fileUrl;
            link.download = fileName.split('/').pop();
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };

        // ==============================================
        // INITIALIZATION
        // ==============================================
        document.addEventListener('DOMContentLoaded', () => {
            setupEventListeners();
            loadCurrentSection();
            
            // Close dropdown when clicking outside
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.field-dropdown')) {
                    document.querySelector('.field-dropdown-content').classList.remove('show');
                }
            });
        });
    </script>
</body>
</html>
